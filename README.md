# 世界モデルを用いたタグ付き協調ゲーム研究フレームワーク

このリポジトリは、谷本純 (2007) が提案したタグ付き囚人のジレンマを、**世界モデルを備えたエージェントによる動的シグナリングゲーム**として再実装し、その協調創発メカニズムを分析するための実験コードです。エージェントは内部世界モデル (記憶・予測モジュール) と制御モジュールから構成され、相手の行動とタグを観測しながら自らの行動 (協調/裏切り) と次に提示するタグを同時に出力します。

## 構成

- `world_model_game/environment.py` — タグ付き囚人のジレンマ環境の実装。観測は相手の前ターンの行動とタグをワンホットで表現し、ターン番号を正規化した特徴も含みます。
- `world_model_game/models.py` — 観測を埋め込み、**アテンション付き GRU** を用いた記憶・予測モジュールと、行動・タグを同時に決定する制御モジュールを定義します。アテンションの重みと対象の履歴が追跡できるよう、観測要約を内部メモリに保持します。
- `world_model_game/training.py` — 共有パラメータによる自己対戦学習を行う REINFORCE+Value Baseline トレーナ。各ステップのログと隠れ状態を保存して分析に利用します。
- `world_model_game/analysis.py` —
  - 隠れ状態から次のタグや相手行動を線形プローブで推定する **プロービング**、
  - 裏切り観測時にアテンションがどの履歴に重みを置くかを集計する **アテンション分析**、
  - 特定ターンのタグを介入的に書き換えた際の協調率変化を測る **因果介入**
  を提供します。
- `scripts/run_experiment.py` — 学習から分析までを一括実行する CLI スクリプト。結果は JSON 形式で保存・出力されます。

## 使い方

1. 依存関係として PyTorch (CPU 版で可) が必要です。ネットワーク制限がある環境では `pip install torch==1.13.1` などの CPU 向けビルドを取得してください。
2. 以下のコマンドで簡単な学習と分析を実行できます。

   ```bash
   python scripts/run_experiment.py --episodes 4000 --max-steps 20
   ```

   実行結果は `experiment_results.json` に出力され、標準出力にも整形済み JSON として表示されます。

3. 主要な引数:

   | 引数 | 説明 | 既定値 |
   | --- | --- | --- |
   | `--episodes` | 学習エピソード数 | 4000 |
   | `--max-steps` | 1 エピソードのステップ数 | 20 |
   | `--num-tags` | タグの種類数 | 4 |
   | `--hidden-dim` | GRU 隠れ状態次元 | 128 |
   | `--attention-dim` | アテンション次元 | 64 |
   | `--attention-window` | メモリに保持する履歴数 | 10 |

## 研究タスクとの対応

- **世界モデルの基本構成要素**: 観測エンコーダと GRU により内部状態を形成し、制御モジュールが行動とタグを出力します。
- **動的タグ入出力**: 各ターンで行動 (C/D) と次タグを同時にサンプリングし、環境に作用します。
- **動的シグナリング分析**:
  - プロービングにより、隠れ状態から相手の次行動や自分の次タグをどれほど復元できるかを計測。
  - アテンション重みを履歴中の行動/タグと紐付け、裏切り観測後に行動履歴へ重みが移るかを統計化。
  - タグ介入でチープトーク信号の因果影響を評価。

これにより、世界モデル内部で構築される信頼度表現や欺瞞的タグ戦略 (Mimic) の萌芽を追跡するための実験基盤を提供します。
